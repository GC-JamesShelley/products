name: $(Date:yyyyMMdd)$(Rev:.r)

                  # $(containerRegistry)/$(imageRepository):$(tag)

stages:
  - stage: Build
    displayName: Build stage
    jobs:  
    - job: Build
      displayName: Build job
      pool:
        vmImage: ubuntu-latest
      steps:
      - task: Docker@2
        displayName: Build and push an image to container registry
        inputs:
          command: buildAndPush
          repository: products/api
          dockerfile: $(Build.SourcesDirectory)/medicines/api/Dockerfile
          containerRegistry: mhraproductsdevregistry
          tags: |
            api-pipeline

      - task: PublishPipelineArtifact@1
        inputs:
          artifactName: 'manifests'
          path: 'manifests'
####################
  - stage: Deploy
    displayName: Deploy stage
    dependsOn: Build
    jobs:
    - deployment: Deploy
      displayName: Deploy job
      pool:
        vmImage: ubuntu-latest
      environment: dev
      strategy:
        runOnce:
          deploy:
            steps:
            - task: DownloadPipelineArtifact@2
              inputs:
                artifactName: 'manifests'
                downloadPath: '$(System.ArtifactsDirectory)/manifests'
            - task: KubernetesManifest@0
              displayName: Deploy to Kubernetes cluster
              inputs:
                kubernetesServiceConnection: aks
                action: deploy
                namespace: default
                manifests: |
                  $(System.ArtifactsDirectory)/manifests/deployment.yml
                  $(System.ArtifactsDirectory)/manifests/service.yml
                  $(System.ArtifactsDirectory)/manifests/virtual-service.yml
                containers: |
                  mhraproductsdevregistry/products/api:api-pipeline